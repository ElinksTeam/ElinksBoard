# æ–¹æ¡ˆ3å®æ–½çŠ¶æ€æ£€æŸ¥

## ğŸ“Š å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆçš„éƒ¨åˆ†

#### 1. è®¤è¯å±‚ï¼ˆå»ä¸­å¿ƒåŒ–ï¼‰
- âœ… **Logto é›†æˆå®Œæˆ**
  - LogtoAuthService å·²åˆ›å»º
  - LogtoAuthController å·²åˆ›å»º
  - è·¯ç”±å·²é…ç½®
  - ä¸­é—´ä»¶å·²æ·»åŠ 
  - é¦–æ¬¡ç”¨æˆ·è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜
  - å®‰è£…æµç¨‹å·²é›†æˆ

**çŠ¶æ€ï¼š100% å®Œæˆ** âœ…

---

#### 2. æ•°æ®å±‚ï¼ˆä¸­å¿ƒåŒ–ï¼‰
- âœ… **æ•°æ®åº“é…ç½®**
  - æ”¯æŒ MySQL/PostgreSQL/SQLite
  - å·²æœ‰å®Œæ•´çš„ Eloquent æ¨¡å‹
  - æ•°æ®åº“è¿ç§»å®Œæ•´
  - æ”¯æŒ Logto ç”¨æˆ·å­—æ®µ

**çŠ¶æ€ï¼š100% å®Œæˆ** âœ…

---

#### 3. ç¼“å­˜å±‚ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
- âœ… **Redis é…ç½®å­˜åœ¨**
  - `.env.example` å·²é…ç½® Redis
  - `CACHE_DRIVER=redis` å·²è®¾ç½®
  - `QUEUE_CONNECTION=redis` å·²è®¾ç½®

- âš ï¸ **ä½†æœªå……åˆ†ä½¿ç”¨**
  - ä»£ç ä¸­ç¼“å­˜ä½¿ç”¨è¾ƒå°‘
  - æ²¡æœ‰ç¼“å­˜ç­–ç•¥æ–‡æ¡£
  - æ²¡æœ‰ç¼“å­˜é¢„çƒ­æœºåˆ¶

**çŠ¶æ€ï¼š40% å®Œæˆ** âš ï¸

---

### âŒ ç¼ºå¤±çš„éƒ¨åˆ†

#### 1. ç›‘æ§ç³»ç»Ÿ
- âŒ æ²¡æœ‰ Prometheus
- âŒ æ²¡æœ‰ Grafana
- âŒ æ²¡æœ‰æ€§èƒ½ç›‘æ§
- âŒ æ²¡æœ‰å‘Šè­¦ç³»ç»Ÿ

**çŠ¶æ€ï¼š0% å®Œæˆ** âŒ

---

#### 2. å¤‡ä»½ç­–ç•¥
- âŒ æ²¡æœ‰è‡ªåŠ¨å¤‡ä»½è„šæœ¬
- âŒ æ²¡æœ‰å¤‡ä»½æ¢å¤æ–‡æ¡£
- âŒ æ²¡æœ‰å¤‡ä»½æµ‹è¯•æµç¨‹

**çŠ¶æ€ï¼š0% å®Œæˆ** âŒ

---

#### 3. é«˜å¯ç”¨é…ç½®
- âŒ æ²¡æœ‰æ•°æ®åº“ä¸»ä»å¤åˆ¶
- âŒ æ²¡æœ‰ Redis Sentinel
- âŒ æ²¡æœ‰è‡ªåŠ¨æ•…éšœè½¬ç§»

**çŠ¶æ€ï¼š0% å®Œæˆ** âŒ

---

#### 4. æ€§èƒ½ä¼˜åŒ–
- âŒ æ²¡æœ‰æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æ–‡æ¡£
- âŒ æ²¡æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ
- âŒ æ²¡æœ‰ç¼“å­˜ç­–ç•¥å®æ–½

**çŠ¶æ€ï¼š0% å®Œæˆ** âŒ

---

## ğŸ¯ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶å—ï¼Ÿ

### ç­”æ¡ˆï¼š**ä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼**

**åŸå› ï¼š**
1. âœ… Logto è®¤è¯å·²å®Œå…¨é›†æˆ
2. âœ… æ•°æ®åº“æ¶æ„å·²å®Œå–„
3. âœ… Redis é…ç½®å·²å­˜åœ¨
4. âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®Œæ•´

**éœ€è¦åšçš„æ˜¯ï¼š**
- ğŸ“ æ·»åŠ é…ç½®æ–‡ä»¶ï¼ˆéä»£ç ï¼‰
- ğŸ“ æ·»åŠ è„šæœ¬ï¼ˆè¿ç»´å·¥å…·ï¼‰
- ğŸ“ æ·»åŠ æ–‡æ¡£ï¼ˆä½¿ç”¨æŒ‡å—ï¼‰

---

## ğŸ“‹ å®æ–½æ¸…å•

### é˜¶æ®µ1ï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆä¸éœ€è¦æ”¹ä»£ç ï¼‰

#### 1.1 å¯ç”¨ Redis ç¼“å­˜

**ä¿®æ”¹ `.env`ï¼š**
```bash
# ç¡®ä¿è¿™äº›é…ç½®æ­£ç¡®
CACHE_DRIVER=redis
QUEUE_CONNECTION=redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
```

**æ¸…é™¤é…ç½®ç¼“å­˜ï¼š**
```bash
php artisan config:cache
php artisan cache:clear
```

**æµ‹è¯• Redisï¼š**
```bash
php artisan tinker
>>> Cache::put('test', 'hello', 60);
>>> Cache::get('test');
```

**ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼** âœ…

---

#### 1.2 æ·»åŠ ç¼“å­˜ä½¿ç”¨ç¤ºä¾‹

**åˆ›å»ºæ–‡æ¡£ï¼š** `docs/CACHING_GUIDE.md`

```markdown
# ç¼“å­˜ä½¿ç”¨æŒ‡å—

## å¸¸ç”¨ç¼“å­˜æ¨¡å¼

### 1. ç¼“å­˜æŸ¥è¯¢ç»“æœ
```php
$plans = Cache::remember('plans', 3600, function() {
    return Plan::all();
});
```

### 2. ç¼“å­˜ç”¨æˆ·æ•°æ®
```php
$user = Cache::remember("user:{$userId}", 1800, function() use ($userId) {
    return User::find($userId);
});
```

### 3. ç¼“å­˜é…ç½®
```php
$settings = Cache::remember('settings', 7200, function() {
    return Setting::all()->pluck('value', 'key');
});
```
```

**ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œåªæ˜¯æä¾›ä½¿ç”¨æŒ‡å—ï¼** âœ…

---

### é˜¶æ®µ2ï¼šæ·»åŠ ç›‘æ§ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰

#### 2.1 åˆ›å»º Docker Compose ç›‘æ§é…ç½®

**åˆ›å»ºæ–‡ä»¶ï¼š** `docker-compose.monitoring.yml`

```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: xboard-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: xboard-grafana
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana-dashboards:/etc/grafana/provisioning/dashboards
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    restart: unless-stopped

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: xboard-redis-exporter
    ports:
      - "9121:9121"
    environment:
      - REDIS_ADDR=redis:6379
    restart: unless-stopped

volumes:
  prometheus-data:
  grafana-data:
```

**å¯åŠ¨ç›‘æ§ï¼š**
```bash
docker-compose -f docker-compose.monitoring.yml up -d
```

**ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç ï¼** âœ…

---

#### 2.2 åˆ›å»º Prometheus é…ç½®

**åˆ›å»ºæ–‡ä»¶ï¼š** `monitoring/prometheus.yml`

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  - job_name: 'xboard'
    static_configs:
      - targets: ['host.docker.internal:8000']
```

**ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼** âœ…

---

### é˜¶æ®µ3ï¼šæ·»åŠ å¤‡ä»½ï¼ˆæ–°å¢è„šæœ¬ï¼‰

#### 3.1 åˆ›å»ºå¤‡ä»½è„šæœ¬

**åˆ›å»ºæ–‡ä»¶ï¼š** `scripts/backup-database.sh`

```bash
#!/bin/bash

# é…ç½®
BACKUP_DIR="/backup/xboard"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="xboard"
DB_USER="root"
DB_HOST="127.0.0.1"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
echo "Starting backup at $DATE..."

if [ "$DB_CONNECTION" = "mysql" ]; then
    mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASSWORD $DB_NAME > $BACKUP_DIR/xboard_$DATE.sql
elif [ "$DB_CONNECTION" = "pgsql" ]; then
    pg_dump -h $DB_HOST -U $DB_USER $DB_NAME > $BACKUP_DIR/xboard_$DATE.sql
fi

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/xboard_$DATE.sql

# åˆ é™¤30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

echo "Backup completed: xboard_$DATE.sql.gz"
```

**æ·»åŠ åˆ° crontabï¼š**
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½
0 2 * * * /path/to/scripts/backup-database.sh
```

**ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼** âœ…

---

#### 3.2 åˆ›å»ºæ¢å¤è„šæœ¬

**åˆ›å»ºæ–‡ä»¶ï¼š** `scripts/restore-database.sh`

```bash
#!/bin/bash

if [ -z "$1" ]; then
    echo "Usage: $0 <backup-file>"
    exit 1
fi

BACKUP_FILE=$1

echo "Restoring from $BACKUP_FILE..."

# è§£å‹
gunzip -c $BACKUP_FILE > /tmp/restore.sql

# æ¢å¤
if [ "$DB_CONNECTION" = "mysql" ]; then
    mysql -h $DB_HOST -u $DB_USER -p$DB_PASSWORD $DB_NAME < /tmp/restore.sql
elif [ "$DB_CONNECTION" = "pgsql" ]; then
    psql -h $DB_HOST -U $DB_USER $DB_NAME < /tmp/restore.sql
fi

rm /tmp/restore.sql

echo "Restore completed!"
```

**ä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼** âœ…

---

### é˜¶æ®µ4ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰çš„ä»£ç æ”¹è¿›ï¼‰

#### 4.1 æ·»åŠ æ•°æ®åº“ç´¢å¼•

**åˆ›å»ºè¿ç§»ï¼š** `database/migrations/2025_10_30_add_performance_indexes.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        // ç”¨æˆ·è¡¨ç´¢å¼•
        Schema::table('v2_user', function (Blueprint $table) {
            $table->index('email', 'idx_user_email');
            $table->index('created_at', 'idx_user_created');
            $table->index(['is_admin', 'banned'], 'idx_user_status');
        });

        // è®¢å•è¡¨ç´¢å¼•
        Schema::table('v2_order', function (Blueprint $table) {
            $table->index('user_id', 'idx_order_user');
            $table->index('status', 'idx_order_status');
            $table->index('created_at', 'idx_order_created');
            $table->index(['user_id', 'status'], 'idx_order_user_status');
        });

        // æœåŠ¡å™¨ç»Ÿè®¡ç´¢å¼•
        Schema::table('v2_server_stat', function (Blueprint $table) {
            $table->index('server_id', 'idx_stat_server');
            $table->index('created_at', 'idx_stat_created');
        });
    }

    public function down(): void
    {
        Schema::table('v2_user', function (Blueprint $table) {
            $table->dropIndex('idx_user_email');
            $table->dropIndex('idx_user_created');
            $table->dropIndex('idx_user_status');
        });

        Schema::table('v2_order', function (Blueprint $table) {
            $table->dropIndex('idx_order_user');
            $table->dropIndex('idx_order_status');
            $table->dropIndex('idx_order_created');
            $table->dropIndex('idx_order_user_status');
        });

        Schema::table('v2_server_stat', function (Blueprint $table) {
            $table->dropIndex('idx_stat_server');
            $table->dropIndex('idx_stat_created');
        });
    }
};
```

**è¿è¡Œè¿ç§»ï¼š**
```bash
php artisan migrate
```

**è¿™æ˜¯å”¯ä¸€éœ€è¦çš„ä»£ç æ”¹åŠ¨ï¼Œè€Œä¸”æ˜¯å¯é€‰çš„ï¼** âš ï¸

---

## ğŸ“Š æ€»ç»“

### éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸éœ€è¦ï¼** âœ…

**åŸå› ï¼š**
1. âœ… æ–¹æ¡ˆ3çš„æ ¸å¿ƒæ¶æ„å·²ç»å®ç°
2. âœ… Logto è®¤è¯å®Œå…¨é›†æˆ
3. âœ… æ•°æ®åº“æ¶æ„å®Œå–„
4. âœ… Redis é…ç½®å·²å­˜åœ¨

---

### éœ€è¦åšä»€ä¹ˆï¼Ÿ

**åªéœ€è¦æ·»åŠ è¿ç»´å·¥å…·å’Œé…ç½®ï¼š**

| ä»»åŠ¡ | ç±»å‹ | æ˜¯å¦ä¿®æ”¹ä»£ç  | ä¼˜å…ˆçº§ |
|------|------|-------------|--------|
| å¯ç”¨ Redis ç¼“å­˜ | é…ç½® | âŒ å¦ | ğŸ”´ é«˜ |
| æ·»åŠ ç›‘æ§ | æ–°å¢æ–‡ä»¶ | âŒ å¦ | ğŸŸ¡ ä¸­ |
| æ·»åŠ å¤‡ä»½ | æ–°å¢è„šæœ¬ | âŒ å¦ | ğŸ”´ é«˜ |
| æ€§èƒ½ä¼˜åŒ–ç´¢å¼• | è¿ç§» | âœ… æ˜¯ï¼ˆå¯é€‰ï¼‰ | ğŸŸ¢ ä½ |

---

### å®æ–½æ­¥éª¤

#### ç«‹å³åšï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# 1. ç¡®ä¿ Redis é…ç½®æ­£ç¡®
cat .env | grep REDIS

# 2. æ¸…é™¤ç¼“å­˜
php artisan config:cache
php artisan cache:clear

# 3. æµ‹è¯• Redis
php artisan tinker
>>> Cache::put('test', 'works', 60);
>>> Cache::get('test');
```

**å®Œæˆï¼æ–¹æ¡ˆ3å·²ç»å¯ä»¥ä½¿ç”¨äº†ï¼** âœ…

---

#### æœ¬å‘¨åšï¼ˆ1-2å°æ—¶ï¼‰

```bash
# 1. åˆ›å»ºå¤‡ä»½è„šæœ¬
mkdir -p scripts
# å¤åˆ¶ä¸Šé¢çš„ backup-database.sh

# 2. è®¾ç½®å®šæ—¶ä»»åŠ¡
crontab -e
# æ·»åŠ : 0 2 * * * /path/to/scripts/backup-database.sh

# 3. æµ‹è¯•å¤‡ä»½
./scripts/backup-database.sh
```

---

#### ä¸‹å‘¨åšï¼ˆ2-3å°æ—¶ï¼‰

```bash
# 1. åˆ›å»ºç›‘æ§é…ç½®
mkdir -p monitoring
# å¤åˆ¶ä¸Šé¢çš„ docker-compose.monitoring.yml

# 2. å¯åŠ¨ç›‘æ§
docker-compose -f docker-compose.monitoring.yml up -d

# 3. è®¿é—® Grafana
# http://localhost:3001
# ç”¨æˆ·å: admin
# å¯†ç : admin
```

---

#### å¯é€‰åšï¼ˆ1å°æ—¶ï¼‰

```bash
# æ·»åŠ æ•°æ®åº“ç´¢å¼•
php artisan make:migration add_performance_indexes
# å¤åˆ¶ä¸Šé¢çš„ç´¢å¼•ä»£ç 
php artisan migrate
```

---

## âœ… æœ€ç»ˆç­”æ¡ˆ

### æ–¹æ¡ˆ3éœ€è¦ä¿®æ”¹æ–‡ä»¶å—ï¼Ÿ

**æ ¸å¿ƒä»£ç ï¼šä¸éœ€è¦ä¿®æ”¹ï¼** âœ…

**éœ€è¦æ·»åŠ çš„ï¼š**
- ğŸ“ é…ç½®æ–‡ä»¶ï¼ˆç›‘æ§ï¼‰
- ğŸ“ è„šæœ¬æ–‡ä»¶ï¼ˆå¤‡ä»½ï¼‰
- ğŸ“ æ–‡æ¡£æ–‡ä»¶ï¼ˆæŒ‡å—ï¼‰
- ğŸ“ å¯é€‰è¿ç§»ï¼ˆç´¢å¼•ä¼˜åŒ–ï¼‰

**æ‰€æœ‰è¿™äº›éƒ½æ˜¯æ–°å¢æ–‡ä»¶ï¼Œä¸ä¿®æ”¹ç°æœ‰ä»£ç ï¼**

---

### å½“å‰çŠ¶æ€è¯„ä¼°

```
æ–¹æ¡ˆ3å®æ–½è¿›åº¦ï¼š

âœ… è®¤è¯å±‚ï¼ˆLogtoï¼‰      [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%
âœ… æ•°æ®å±‚ï¼ˆPostgreSQLï¼‰  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%
âš ï¸ ç¼“å­˜å±‚ï¼ˆRedisï¼‰       [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]  40%
âŒ ç›‘æ§ç³»ç»Ÿ              [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]   0%
âŒ å¤‡ä»½ç­–ç•¥              [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]   0%

æ€»ä½“è¿›åº¦ï¼š                [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]  60%
```

**ç»“è®ºï¼šæ ¸å¿ƒæ¶æ„å·²å®Œæˆï¼Œåªéœ€æ·»åŠ è¿ç»´å·¥å…·ï¼** âœ…

---

### æ¨èè¡ŒåŠ¨

**ä»Šå¤©ï¼š**
1. âœ… ç¡®è®¤ Redis é…ç½®
2. âœ… æµ‹è¯•ç¼“å­˜åŠŸèƒ½

**æœ¬å‘¨ï¼š**
1. ğŸ“ åˆ›å»ºå¤‡ä»½è„šæœ¬
2. ğŸ“ è®¾ç½®å®šæ—¶å¤‡ä»½

**ä¸‹å‘¨ï¼š**
1. ğŸ“ æ·»åŠ ç›‘æ§ç³»ç»Ÿ
2. ğŸ“ é…ç½®å‘Šè­¦

**å¯é€‰ï¼š**
1. ğŸ“ æ·»åŠ æ€§èƒ½ç´¢å¼•
2. ğŸ“ ä¼˜åŒ–æ…¢æŸ¥è¯¢

---

**æ€»ç»“ï¼šæ–¹æ¡ˆ3å·²ç»åŸºæœ¬å®ç°ï¼Œä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç ï¼Œåªéœ€è¦æ·»åŠ è¿ç»´å·¥å…·å’Œé…ç½®ï¼** ğŸ‰
