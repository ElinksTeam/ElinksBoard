name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v4.1.0
        with:
          myToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ğŸ‰ ElinksBoard ${{ steps.version.outputs.version }}

          ### âœ¨ æ–°åŠŸèƒ½

          - æŸ¥çœ‹å®Œæ•´çš„å˜æ›´æ—¥å¿—äº†è§£æ‰€æœ‰æ›´æ–°

          ### ğŸ› Bug ä¿®å¤

          - æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†ä¿¡æ¯

          ### ğŸ“¦ å®‰è£…æ–¹å¼

          #### Docker Composeï¼ˆæ¨èï¼‰
          \`\`\`bash
          git clone --depth 1 https://github.com/ElinksTeam/ElinksBoard
          cd ElinksBoard
          cp compose.sample.yaml docker-compose.yml
          docker compose up -d
          \`\`\`

          #### Docker é•œåƒ
          \`\`\`bash
          docker pull ghcr.io/elinksteam/elinksboard:${{ steps.version.outputs.version }}
          \`\`\`

          ### ğŸ“š æ–‡æ¡£

          - [å®‰è£…æŒ‡å—](https://github.com/ElinksTeam/ElinksBoard/blob/master/INSTALLATION_GUIDE.md)
          - [Logto è®¾ç½®](https://github.com/ElinksTeam/ElinksBoard/blob/master/LOGTO_SETUP.md)
          - [å®Œæ•´æ–‡æ¡£](https://github.com/ElinksTeam/ElinksBoard/blob/master/README_CN.md)

          ### âš ï¸ é‡è¦æç¤º

          1. **å¤‡ä»½æ•°æ®**ï¼šå‡çº§å‰è¯·åŠ¡å¿…å¤‡ä»½æ•°æ®åº“å’Œé…ç½®æ–‡ä»¶
          2. **Logto é…ç½®**ï¼šé¦–æ¬¡å®‰è£…éœ€è¦é…ç½® Logto è®¤è¯
          3. **é¦–æ¬¡ç™»å½•**ï¼šå®‰è£…åç«‹å³å®Œæˆé¦–æ¬¡ç™»å½•ä»¥è·å–ç®¡ç†å‘˜æƒé™

          ### ğŸ”„ å‡çº§æŒ‡å—

          \`\`\`bash
          # åœæ­¢æœåŠ¡
          docker compose down

          # å¤‡ä»½æ•°æ®
          cp database/database.sqlite database/database.sqlite.backup
          ./scripts/backup-redis.sh

          # æ‹‰å–æœ€æ–°ä»£ç 
          git pull

          # æ‹‰å–æœ€æ–°é•œåƒ
          docker compose pull

          # è¿è¡Œè¿ç§»
          docker compose run --rm web php artisan migrate --force

          # å¯åŠ¨æœåŠ¡
          docker compose up -d
          \`\`\`

          ### ğŸ“ å®Œæ•´å˜æ›´æ—¥å¿—

          ${{ steps.changelog.outputs.changelog }}

          ---

          **å®Œæ•´å˜æ›´**: https://github.com/ElinksTeam/ElinksBoard/compare/${{ steps.version.outputs.version }}...master
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-release-assets:
    name: Build Release Assets
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Create release archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          tar -czf elinksboard-${VERSION}.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            .

      - name: Upload release asset
        uses: softprops/action-gh-release@v1
        with:
          files: elinksboard-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [create-release, build-release-assets]
    if: always()
    
    steps:
      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Notification
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ] && \
             [ "${{ needs.build-release-assets.result }}" == "success" ]; then
            echo "âœ… Release ${{ steps.version.outputs.version }} created successfully"
            echo "ğŸ“¦ Download: https://github.com/ElinksTeam/ElinksBoard/releases/tag/${{ steps.version.outputs.version }}"
          else
            echo "âŒ Release creation failed"
            exit 1
          fi
